{% extends 'base.html' %}

{% load bootstrap4 %}
{% load render_table from django_tables2 %}
{% load count_courses %}
{% load multiply_icon %}


{% block content %}
  {% if category %}
    <h1>{{ category.name }}</h1>
    {% if category.description %}
      <p>{{ category.description }}</p>
    {% endif %}
  {% else %}
    <h1>–í—Å–µ –∫—É—Ä—Å—ã</h1>
  {% endif %}

  {% if category %}
    {% if category.get_root == category %}
      <div class="badges mt-5">
        <a href="{% url 'courses:list' %}?categories={{ category.pk }}" class="badge badge-dark">–í—Å–µ ({{ category.get_family|count_courses }})</a>
        {% for child in category.get_children %}
          <a href="{% url 'courses:list' %}?categories={{ child.pk }}" class="badge badge-primary">{{ child.name }} ({{ child.course_set.count }})</a>
        {% endfor %}
      </div>
    {% else %}
      <div class="badges mt-5">
        <a href="{% url 'courses:list' %}?categories={{ category.get_root.pk }}" class="badge badge-primary">{{ category.get_root.name }} ({{ category.get_root.get_family|count_courses }})</a>
        {% for child in category.get_root.get_children %}
          <a href="{% url 'courses:list' %}?categories={{ child.pk }}" class="badge {% if request.GET.categories == child.pk|slugify %}badge-dark{% else %}badge-primary{% endif %}">{{ child.name }} ({{ child.course_set.count }})</a>
        {% endfor %}
      </div>
    {% endif %}
  {% endif %}

  <form class="mt-5">
    {% if request.GET.categories %}
      <input type="hidden" name="categories" value="{{ request.GET.categories }}">
    {% endif %}
    <div>
      <div class="form-row align-items-center">
        <div class="col-lg">
          <label for="school">–®–∫–æ–ª–∞</label>
          <select id="school" class="form-control" name="school">
            <option value="" {% if not request.GET.school %}selected{% endif %}>–õ—é–±–∞—è</option>
            {% for school in schools %}
              <option value="{{ school.pk }}" {% if request.GET.school == school.pk|slugify %}selected{% endif %}>{{ school.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-lg">
          <label for="rating">–†–µ–π—Ç–∏–Ω–≥</label>
          <select id="rating" class="form-control" name="school__rating">
            <option value="" {% if not request.GET.school__rating %}selected{% endif %}>–õ—é–±–æ–π</option>
            {% for score in '54321' %}
              <option value="{{ score }}" {% if request.GET.school__rating == score %}selected{% endif %}>{% multiply_icon '‚≠ê' score %}</option>
            {% endfor %}
          </select>
        </div>
        <div class="col-lg">
          <label for="price">–¶–µ–Ω–∞</label>
          <select id="price" class="form-control" name="price_category">
            <option value="" {% if not request.GET.price_category %}selected{% endif %}>–õ—é–±–∞—è</option>
            {% for number in '54321' %}
              <option value="{{ number }}" {% if request.GET.price_category == number %}selected{% endif %}>{% multiply_icon 'üí∞' number %}</option>
            {% endfor %}
            <option value="0" {% if request.GET.price_category == 0 %}selected{% endif %}>–ë–µ—Å–ø–ª–∞—Ç–Ω–æ</option>
          </select>
        </div>
        <div class="col-lg">
          <label for="duration">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</label>
          <select id="duration" class="form-control" name="duration_category">
            <option value="" {% if not request.GET.duration_category %}selected{% endif %}>–õ—é–±–∞—è</option>
            {% for number in '54321' %}
              <option value="{{ number }}" {% if request.GET.duration_category == number %}selected{% endif %}>{% multiply_icon '‚è≥' number %}</option>
            {% endfor %}
          </select>
        </div>
      </div>


      {#    <div class="col-lg">#}
      {#      <div class="form-check">#}
      {#        <input class="form-check-input" type="checkbox" id="free" name="free" value="true" {% if request.GET.free == 'true' %}checked{% endif %}>#}
      {#        <label class="form-check-label" for="free">–¢–æ–ª—å–∫–æ –±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ</label>#}
      {#      </div>#}
      {#    </div>#}

      {#      <div class="col-lg d-lg-flex flex-row-reverse mt-3 mt-lg-0">#}
      <div class="mt-3">
        <button type="submit" class="btn btn-primary">–ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä</button>
        {% if request.GET.categories %}
          <a href="{% url 'courses:list' %}?categories={{ request.GET.categories }}" class="btn btn-warning">–°–±—Ä–æ—Å–∏—Ç—å</a>
        {% else %}
          <a href="{% url 'courses:list' %}" class="btn btn-warning">–°–±—Ä–æ—Å–∏—Ç—å</a>
        {% endif %}
      </div>
    </div>
  </form>

  <div id='table'>
    {% include 'courses/table.html' %}
  </div>
{% endblock content %}

{% block script %}
  <script>
      function nextPageHandler(e) {
          e.preventDefault();

          const $obj = $(this);
          const urlLink = $obj.attr("href");

          $obj.unbind("click", nextPageHandler);

          $.get(urlLink, function (data) {
              $('#table').html(data)
              $('html, body').animate({scrollTop: $(document).height()}, 0);
          }).done(function () {
              $('#show-more').bind("click", nextPageHandler);
          });
      }

      $('#show-more').click(nextPageHandler);
  </script>
{% endblock %}
