{% extends 'base.html' %}

{% load bootstrap4 %}
{% load render_table from django_tables2 %}
{% load count_courses %}
{% load multiply_icon %}


{% block content %}
  {% if category %}
    <h1>{{ category.name }}</h1>
    {% if category.description %}
      <p>{{ category.description|safe }}</p>
    {% endif %}
  {% else %}
    <h1>Все курсы</h1>
  {% endif %}

  {% if category %}
    {% if category.get_root == category %}
      <div class="badges mt-5">
        <a href="{% url 'courses:category' slug=category.slug %}" class="badge badge-dark">{{ category.name }} ({{ category.get_family|count_courses }})</a>
        {% for child in category.get_children %}
          <a href="{% url 'courses:category' slug=child.slug %}" class="badge badge-primary">{{ child.name }} ({{ child.course_set.count }})</a>
        {% endfor %}
      </div>
    {% else %}
      <div class="badges mt-5">
        <a href="{% url 'courses:category' slug=category.get_root.slug %}" class="badge badge-primary">{{ category.get_root.name }} ({{ category.get_root.get_family|count_courses }})</a>
        {% for child in category.get_root.get_children %}
          <a href="{% url 'courses:category' slug=child.slug %}" class="badge {% if request.resolver_match.kwargs.slug == child.slug %}badge-dark{% else %}badge-primary{% endif %}">{{ child.name }} ({{ child.course_set.count }})</a>
        {% endfor %}
      </div>
    {% endif %}
  {% endif %}

  <form id="filter-form" class="mt-5">
{#    {% if category %}#}
{#      <input type="hidden" name="categories" value="{{ category.id }}">#}
{#    {% endif %}#}
    <input id="free" type="hidden" name="free">
    <div>
      <div class="form-row align-items-center">
        <div class="col-lg">
          <select id="filter-select" class="form-control" name="sort">
            <option value="" {% if not request.GET.school %}selected{% endif %} data-free="">Популярные</option>
            <option value="" {% if request.GET.free == 'true' %}selected{% endif %} data-free="true">Бесплатные</option>
            <option value="price" {% if request.GET.sort == 'price' %}selected{% endif %} data-free="false">Сначала дешевые</option>
            <option value="-price" {% if request.GET.sort == '-price' %}selected{% endif %} data-free="false">Сначала дорогие</option>
            <option value="duration" {% if request.GET.sort == 'duration' %}selected{% endif %} data-free="">Сначала короткие</option>
            <option value="-duration" {% if request.GET.sort == '-duration' %}selected{% endif %} data-free="">Сначала долгие</option>
            <option value="-rating" {% if request.GET.sort == '-rating' %}selected{% endif %} data-free="">С высоким рейтингом</option>
          </select>
        </div>
      </div>
    </div>
  </form>

  <div id='table'>
    {% include 'courses/table.html' %}
  </div>
{% endblock content %}

{% block script %}
  <script>
      function nextPageHandler(e) {
          e.preventDefault();

          const $obj = $(this);
          const urlLink = $obj.attr("href");

          $obj.unbind("click", nextPageHandler);

          $.get(urlLink, function (data) {
              $('#table').html(data)
              $('html, body').animate({scrollTop: $(document).height()}, 0);
          }).done(function () {
              $('#show-more').bind("click", nextPageHandler);
          });
      }

      $('#show-more').click(nextPageHandler);

      const filterSelect = $('#filter-select');

      filterSelect.on('change', function () {
          const freeInput = $('#free')

          freeInput.val($(this).children("option:selected").data('free'))

          filterSelect.prop('disabled', !filterSelect.val());
          freeInput.prop('disabled', !freeInput.val());

          $('#filter-form').submit();
      });
  </script>
{% endblock %}
